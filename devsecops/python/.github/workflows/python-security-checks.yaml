name: CI/CD Security Checks for Python

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      # 1. Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      # 2. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 3. Lint code with Flake8
      - name: Run Flake8 for linting
        run: |
          flake8 .

      # 4. Run Bandit for security issues
      - name: Run Bandit for security issues
        run: |
          bandit -r .

      # 5. Run Safety for known vulnerabilities
      - name: Run Safety to check for vulnerabilities
        run: |
          safety check --full-report

      # 6. Check for secret leaks in the code
      - name: Check for secrets in code
        uses: paulirish/secretlint-action@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # 7. Fail if high vulnerabilities are found
      - name: Fail if high vulnerabilities are found
        run: |
          HIGH_VULN_COUNT=$(safety check --json | jq '[.[] | select(.vuln_level=="High")] | length')
          if [ "$HIGH_VULN_COUNT" -gt 0 ]; then
            echo "High severity vulnerabilities found!"
            exit 1
          fi

      # 8. Create an issue if any step fails
      - name: Create an issue if security checks fail
        if: failure()  # Trigger if any previous step failed
        uses: peter-evans/create-issue-from-file@v3
        with:
          title: "Security Issue: CI/CD Checks Failed"
          body: |
            **Description:**  
            The CI/CD security checks failed in the pipeline for the repository. Please address the vulnerabilities or issues detected in the latest build.
            
            **Check Summary:**
            - Flake8: Linting failed.
            - Bandit: Security issues detected.
            - Safety: Vulnerabilities found.
            - Secret Detection: Secrets detected.
            
            **Action Required:**
            - Review the security issues in the build logs and fix them as soon as possible.
          labels: "security, bug"
          assignees: ${{ github.actor }}  # Dynamically assigns to the committer

      # 9. Deploy to Cloud (only if no security issues)
      - name: Deploy to Cloud (if secure)
        if: success()  # Deploy only if all checks pass
        run: |
          gcloud auth activate-service-account --key-file=${{ secrets.GCP_SA_KEY }}
          gcloud app deploy
